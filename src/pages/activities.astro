---
import AuthenticatedLayout from "@/layouts/AuthenticatedLayout.astro";
import { TopBar } from "@/components/TopBar";
import { ActivitiesPageContainer } from "@/components/ActivitiesPageContainer";
import type { AuthUserBasicDto } from "@/types";
import {
  getOpenRouterService,
  getFallbackMotivation,
  isAIMotivationEnabled,
  aggregateActivityStats,
} from "@/lib/services";
import type { MotivationalMessage } from "@/lib/services";
import type { RuntimeEnv } from "@/env";
import { logger } from "@/lib/utils/logger";

// Disable prerendering for this page (SSR)
export const prerender = false;

// Get runtime environment from Cloudflare (if available)
const runtimeEnv = (Astro.locals as { runtime?: { env: RuntimeEnv } }).runtime?.env;

// Get authenticated user from middleware
const authenticatedUser = Astro.locals.user;

// This should never happen due to middleware, but handle gracefully
if (!authenticatedUser) {
  return Astro.redirect("/auth/login");
}

const user: AuthUserBasicDto = {
  userId: authenticatedUser.id,
  email: authenticatedUser.email,
};

// Fetch user's preferred distance unit from profile
let distanceUnit: "km" | "mi" = "km";
try {
  const supabase = Astro.locals.supabase;
  const { data: profile } = await supabase.from("profiles").select("distance_unit").eq("user_id", user.userId).single();

  if (profile?.distance_unit) {
    distanceUnit = profile.distance_unit as "km" | "mi";
  }
} catch (error) {
  logger.error("[Activities Page] Failed to fetch user profile:", { error });
  // Continue with default 'km'
}

// Get current month info
const now = new Date();
const currentMonth = now.getMonth() + 1;
const currentYear = now.getFullYear();

// Generate motivation only for current month and if feature is enabled
let motivation: MotivationalMessage | null = null;
let initialMotivationError: string | null = null;
const aiMotivationEnabled = isAIMotivationEnabled(runtimeEnv);

logger.debug("[Activities Page] AI Motivation enabled:", { aiMotivationEnabled });

if (aiMotivationEnabled) {
  try {
    // Get Supabase client from Astro locals
    const supabase = Astro.locals.supabase;

    logger.debug("[Activities Page] Aggregating activity stats...");
    // Aggregate activity stats
    const stats = await aggregateActivityStats(supabase, user.userId, now, distanceUnit);
    logger.debug("[Activities Page] Stats aggregated:", { stats });

    // Generate AI motivation
    const service = getOpenRouterService(runtimeEnv);
    logger.debug("[Activities Page] OpenRouter service initialized:", { serviceInitialized: !!service });

    if (service) {
      try {
        logger.debug("[Activities Page] Calling generateMotivationalMessage...");
        motivation = await service.generateMotivationalMessage(user.userId, stats);
        logger.debug("[Activities Page] AI motivation generated successfully:", { motivation });
      } catch (error) {
        logger.error("[Activities Page] Failed to generate AI motivation:", { error });
        const errorMessage = error instanceof Error ? error.message : "Failed to generate motivation";
        initialMotivationError = errorMessage;
        // Use fallback - generic motivational text in English
        motivation = getFallbackMotivation(stats);
        logger.debug("[Activities Page] Using fallback motivation:", { motivation });
      }
    } else {
      // Service not initialized, use fallback
      logger.debug("[Activities Page] Service not initialized, using fallback");
      initialMotivationError = "AI service not available";
      motivation = getFallbackMotivation(stats);
      logger.debug("[Activities Page] Fallback motivation:", { motivation });
    }
  } catch (error) {
    logger.error("[Activities Page] Failed to aggregate stats:", { error });
    initialMotivationError = error instanceof Error ? error.message : "Failed to load activity stats";
    // No motivation if stats unavailable
  }
} else {
  logger.debug("[Activities Page] AI motivation is disabled");
}
---

<AuthenticatedLayout title="Activities - Activity Logger" user={user}>
  <!-- TopBar mounted in nav slot -->
  <TopBar client:load user={user} />

  <!-- Main page container with all components -->
  <ActivitiesPageContainer
    client:load
    user={user}
    distanceUnit={distanceUnit}
    currentMonth={currentMonth}
    currentYear={currentYear}
    initialMotivation={motivation}
    initialMotivationError={initialMotivationError}
    aiMotivationEnabled={aiMotivationEnabled}
  />
</AuthenticatedLayout>
