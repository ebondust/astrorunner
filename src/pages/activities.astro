---
import AuthenticatedLayout from "@/layouts/AuthenticatedLayout.astro";
import { TopBar } from "@/components/TopBar";
import { ActivitiesPageContainer } from "@/components/ActivitiesPageContainer";
import type { AuthUserBasicDto } from "@/types";
import { isAIMotivationEnabled } from "@/lib/services";
import type { RuntimeEnv } from "@/env";
import { logger } from "@/lib/utils/logger";

// Disable prerendering for this page (SSR)
export const prerender = false;

// Get runtime environment from Cloudflare (if available)
const runtimeEnv = (Astro.locals as { runtime?: { env: RuntimeEnv } }).runtime?.env;

// Get authenticated user from middleware
const authenticatedUser = Astro.locals.user;

// This should never happen due to middleware, but handle gracefully
if (!authenticatedUser) {
  return Astro.redirect("/auth/login");
}

const user: AuthUserBasicDto = {
  userId: authenticatedUser.id,
  email: authenticatedUser.email,
};

// Fetch user's preferred distance unit from profile
let distanceUnit: "km" | "mi" = "km";
try {
  const supabase = Astro.locals.supabase;
  const { data: profile } = await supabase.from("profiles").select("distance_unit").eq("user_id", user.userId).single();

  if (profile?.distance_unit) {
    distanceUnit = profile.distance_unit as "km" | "mi";
  }
} catch (error) {
  logger.error("[Activities Page] Failed to fetch user profile:", { error });
  // Continue with default 'km'
}

// Get current month info
const now = new Date();
const currentMonth = now.getMonth() + 1;
const currentYear = now.getFullYear();

// Check if AI motivation feature is enabled (actual fetching happens client-side)
const aiMotivationEnabled = isAIMotivationEnabled(runtimeEnv);
logger.debug("[Activities Page] AI Motivation enabled:", { aiMotivationEnabled });
---

<AuthenticatedLayout title="Activities - Activity Logger" user={user}>
  <!-- TopBar mounted in nav slot -->
  <TopBar client:load user={user} />

  <!-- Main page container with all components -->
  <ActivitiesPageContainer
    client:load
    user={user}
    distanceUnit={distanceUnit}
    currentMonth={currentMonth}
    currentYear={currentYear}
    aiMotivationEnabled={aiMotivationEnabled}
  />
</AuthenticatedLayout>
